import {
    Directive,
    EventEmitter,
    HostListener,
    Inject,
    Input,
    Output,
    OnInit
} from "@angular/core";
import { DOCUMENT } from "@angular/common";
import { Logger } from "angular2-logger/app/core/logger";

/**
 * Directive that provides copy to clipboard functionality.
 */
/**
 * <example-url>./../../../demo/index.html#/clipboard</example-url>
 */
@Directive({
    selector: "[xuiClipboard]"
})
export class ClipboardDirective implements OnInit {
    /**
     * Text to be copied to the clipboard
     */
    @Input("xuiClipboard") public textToCopy: string;
    /**
     * Event that is fired when text was copied to the clipboard successfully
     */
    @Output() public clipboardSuccess = new EventEmitter<void>();
    /**
     * Event that is fired when copy text was failed
     */
    @Output() public clipboardError = new EventEmitter<void>();

    /**
     * Replaces element click behavior with clipboard copy event
     */
    @HostListener("click", ["$event"])
    public onClick(e: Event): void {
        if (_.isEqual(this.hasCopySupport, true)) {
            e.preventDefault();
            return this.copyText();
        } else {
            this.clipboardError.emit();
            return this.logger.error("document copy operation is not supported");
        }
    }

    private hasCopySupport = false;

    constructor(private logger: Logger,
                @Inject(DOCUMENT) private document: Document) {}

    public ngOnInit(): void {
        try {
            this.hasCopySupport = this.document.queryCommandSupported("copy");
        } catch (ex) {
            this.logger.error(ex.message);
        }
    }

    private copyText(): void {
        if (_.isEmpty(this.textToCopy) || !_.isString(this.textToCopy)) {
            return this.logger.warn("notext", "xuiClipboard text is empty or not a string");
        }

        const node = this.createNode(this.textToCopy);

        try {
            const selection = this.document.getSelection();
            this.document.body.appendChild(node);
            node.select();
            this.document.execCommand("copy");
            selection.removeAllRanges();
            this.clipboardSuccess.emit();
        } catch (ex) {
            this.logger.error(ex.message);
            this.clipboardError.emit();
        } finally {
            this.document.body.removeChild(node);
        }
    }

    private createNode = (text: string): HTMLTextAreaElement => {
        const node = this.document.createElement("textarea");

        node.style.position = "absolute";
        node.style.left = "-10000px";
        node.textContent = text;

        return node;
    };
}
