(function() {
    "use strict";

    Xui.module
        .controller("DemoBusyController", DemoBusyController, ["$timeout", "$interval", "xuiToastService"]);

    function DemoBusyController($timeout, $interval, toast) {
        var vm = this;
        var cancellation;

        // busy with no progress bar

        vm.isBusy = false;
        vm.isCancelling = false;
        vm.showCancelButton = true;

        vm.save = function() {
            vm.busyMessage = "We're loading something very heavy...";
            vm.isBusy = true;
            vm.showProgress = false;
            vm.showCancelButton = true;

            cancellation = $timeout(function() {
                toast.success("Save complete!");
                vm.isBusy = false;
            }, 5000);
        };

        vm.onCancel = function() {
            if (vm.isCancelling) return;

            $timeout.cancel(cancellation);
            vm.isCancelling = true;
            vm.busyMessage = "Cancelling...";

            vm.showCancelButton = false;
            $timeout(function() {
                toast.error("Save cancelled!");
                vm.isCancelling = vm.isBusy = false;
            }, 2000);
        };

        // busy with progress bar

        var cancellationNotes;
        vm.isBusySavingNotes = false;
        vm.isCancellingNotes = false;
        vm.showCancelButtonNotes = true;

        vm.saveNotes = function() {
            vm.saveNotesMessage = "We're saving lots of notes...";
            vm.isBusySavingNotes = true;
            vm.showCancelButtonNotes = true;
            vm.showProgress = true;
            vm.percent = 0;
            vm.helpText = "This won't take long...";

            cancellationNotes = $interval(vm.updateProgress, 500);
        };

        vm.updateProgress = function() {
            if (vm.percent < 110) {
                vm.percent += 10;
            } else {
                vm.isBusySavingNotes = false;
                vm.stopProgress();
                toast.success("Notes saved!");
            }
        };

        vm.stopProgress = function() {
            $interval.cancel(cancellationNotes);
            vm.percent = 0;
        };

        vm.onCancelNotes = function() {
            if (vm.isCancelling) return;

            vm.stopProgress();
            vm.isCancellingNotes = true;
            vm.saveNotesMessage = "Cancelling notes...";
            vm.helpText = "";

            vm.showCancelButtonNotes = false;
            vm.showProgress = false;
            $timeout(function() {
                toast.error("Save notes cancelled!");
                vm.isCancellingNotes = vm.isBusySavingNotes = false;
            }, 2000);
        };
    }
})();
