/**
 * @ngdoc directive
 * @name xui.directive:xuiWatchCounter
 * @restrict A
 *
 * @description
 * The `xuiWatchCounter` directive allows you to see the count of watches on any of the HTML elements.
 *
 * @element ANY
 *
 * @example
 * <example module="xui">
 *     <file src="src/components/watchCounter/docs/watchCounter-examples.html" name="index.html"></file>
 * </example>
 */
import Inject from "../../decorators/di";

export default class WatchCounter implements ng.IDirective {
    constructor(@Inject("$timeout") private $timeout:ng.ITimeoutService,
                @Inject("swUtil") private swUtil:xui.IUtility,
                @Inject("constants") private constants:any) {}

    public restrict = "A";
    public link = (scope:ng.IScope, element:ng.IAugmentedJQuery) => {
        if (this.constants.environment.name === "development") {
            const interval = this.constants.watchCountInterval;

            if (interval && interval > 0) {
                // Append the count badge to the element to monitor.
                element.css({ position: "relative" });
                const $badgeEl = angular.element(`<div class="xui-watch-counter" title="angular watch count"></div>`);
                element.append($badgeEl);

                let timeoutPromise:ng.IPromise<void>;
                const updateWatches = () => {
                    const currentWatches = this.swUtil.countAngularWatchers(element);
                    $badgeEl.text(currentWatches);
                    timeoutPromise = this.$timeout(updateWatches, interval);
                };
                scope.$on("$destroy", () => {
                    if (timeoutPromise) {
                        this.$timeout.cancel(timeoutPromise);
                    }
                });

                // Highlight the element we are monitoring when the user hovers over the badge.
                $badgeEl.hover(
                    () => { element.addClass("xui-watch-counter__highlight");},
                    () => { element.removeClass("xui-watch-counter__highlight");}
                );

                updateWatches();
            }
        }
    };
}
