export default class Diagnostics implements ng.IDirective {
    public static $inject = ["$timeout", "$translate", "$document", "swUtil", "constants"];

    constructor(private $timeout:ng.ITimeoutService, private $translate:angular.translate.ITranslateService,
                private $document:ng.IDocumentService, private swUtil:any, private constants:any) {
    }

    public restrict = "E";
    public templateUrl = "xui/components/diagnostics/diagnostics-directive.html";
    public transclude = false;
    public replace = true;

    public link = (scope:ng.IScope, element:ng.IAugmentedJQuery, attr:ng.IAttributes) => {
        if (this.constants["environment"]["name"] !== "development") {
            element.remove();
        } else {
            this.updateDiagnostics(element);
        }
    };

    private updateDiagnostics = ($element:ng.IAugmentedJQuery) => {
        const $watchCount = $element.find("#angularWatchCount");
        const $currentLang = $element.find("#currentLanguage");

        if ($watchCount) {
            $watchCount.html(this.swUtil.countAngularWatchers(this.$document));
        }

        if ($currentLang) {
            $currentLang.html(this.$translate.preferredLanguage());
        }

        const delay = this.constants["watchCountInterval"];
        if (delay && delay > 0) {
            this.$timeout(() => this.updateDiagnostics($element), delay);
        }
    };
}
