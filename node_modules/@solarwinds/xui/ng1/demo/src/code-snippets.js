(function () {
    "use strict";

    var entityMap = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': '&quot;',
        "'": '&#39;',
        "/": '&#x2F;'
    };
    var nonSpace = /\S/;

    function escapeHtml(string) {
        return String(string).replace(/[&<>"'\/]/g, function (s) {
            return entityMap[s];
        });
    }

    function trimIndent(content) {
        var lines = content.split("\n"), begin = 0, end = lines.length-1;
        var begin = 0;
        while ((nonSpace.exec(lines[begin]) == null) && (begin < lines.length)) {
            begin = begin + 1;
        }
        while ((nonSpace.exec(lines[end]) == null) && end >= begin) {
            end = end - 1;
        }
        var ident = nonSpace.exec(lines[begin]).index;
        var formatted = "";
        for (var i = begin; i <= end; i++) {
            formatted = formatted + lines[i].slice(ident-1) + ((i < end)? "\n" : "");
        }
        return formatted;
    }

    /**
     * These directives handle for displaying demo templates/scripts
     */
    Xui.factory("$savedContent", function() {
        return [];
    });

    Xui.directive("saveContent", function($savedContent, $compile) {
        return {
            priority: 1000,
            restrict: "A",
            compile: function($element, $attrs) {
                var content = $element.html();
                $savedContent[$attrs.saveContent] = content;
            }
        }
    }, ['$savedContent', '$compile']);

    Xui.directive("applyContent", function($savedContent) {
        return {
            restrict: "A",
            link: function($scope, $element, $attrs) {
                var content = $savedContent[$attrs.applyContent];
                if (!content) {
                    //console.warn("No content with id ", $attrs.applyContent, " found!");
                    return;
                }

                var lang = $attrs.highlightLang;
                if (lang == "html") {
                    content = escapeHtml(content);
                }
                content = trimIndent(content);
                //var pre = prettyPrintOne(content, lang);
                $element.html(/*pre*/content);
            }
        }
    }, ['$savedContent']);
}());
