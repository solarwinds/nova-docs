<div ng-controller="GridDemoCtrl as vm" id="grid-page">
    <xui-grid items-source="vm.simple.items"
              selection-property="id"
              pagination-data="vm.simple.pagination"
              sorting-data="vm.simple.sorting"
              selection-mode="{{vm.simple.slectionMode}}"
              template-url="simple-template"
              selection="vm.simple.selection"
              options="vm.options"
              on-search-change="vm.onSearchChange(item)"
              on-search="vm.onSearch(item,cancellation)"
              on-clear="vm.onClear()"
              show-selector="true">

        <xui-grid-toolbar-container>
            <xui-toolbar>
                <xui-toolbar-item>
                    <xui-button icon="add" display-style="tertiary" ng-click="vm.toolbarButtonClicked(vm.selection)">Add
                    </xui-button>
                </xui-toolbar-item>
                <xui-toolbar-item>
                    <xui-button icon="edit" display-style="tertiary" ng-click="vm.toolbarButtonClicked(vm.selection)">
                        Custom Property Editor
                    </xui-button>
                </xui-toolbar-item>
                <xui-toolbar-divider></xui-toolbar-divider>
                <xui-toolbar-item>
                    <xui-menu title="more actions" display-style="tertiary">
                        <xui-menu-action action="vm.onMenuItemAction(vm.selection)">Add</xui-menu-action>
                        <xui-menu-action action="vm.onMenuItemAction(vm.selection)">Edit</xui-menu-action>
                        <xui-menu-action action="vm.onMenuItemAction(vm.selection)">Delete</xui-menu-action>
                    </xui-menu>
                </xui-toolbar-item>
                <xui-toolbar-splitter></xui-toolbar-splitter>
            </xui-toolbar>
        </xui-grid-toolbar-container>
    </xui-grid>
    <div>Current page: <span id="pagination-page">{{vm.simple.pagination.page}}</span></div>
</div>

<script type="text/ng-template" id="simple-template">{{item.name}}</script>

<script type="text/javascript">
    (function () {
        angular.module("xui").controller("GridDemoCtrl", controller);

        function controller($scope, $timeout) {
            var vm = this;
            var initializing = true;
            var total = 200;

            vm.simple = {
                sorting: {
                    sortableColumns: [{"id": "name", "label": "Name"}],
                    sortBy: {"id": "name", "label": "Name"},
                    direction: "asc"
                },
                pagination: {
                    page: 1,
                    pageSize: 10,
                    total: total
                },
                items: [],
                selection: {
                    items: []
                },
                slectionMode: "multi"
            };

            vm.options = {
                triggerSearchOnChange: true
            };

            vm.searchModel = null;

            vm.onSearch = function (item, cancellation) {
                vm.searchModel = item;

                cancellation.then(function () {
                    vm.searchModel = null;
                    refreshItems();
                });

                refreshItems();
            };

            vm.onClear = function () {
                refreshItems();
            };

            vm.onSearchChange = function (item) {
                vm.searchModel = item;

                if (this.options.triggerSearchOnChange) {
                    refreshItems();
                }
            };

            var items = [];

            for (var i = 0; i < total; i++) {
                items.push({
                    id: i + 1,
                    name: "Item " + pad(i, 3),
                    value: makeValue()
                });
            }

            function makeValue() {
                var text = "";
                var possible = "abcdefghijklmnopqrstuvwxyz";

                for (var i = 0; i < 10; i++)
                    text += possible.charAt(Math.floor(Math.random() * possible.length));

                return text;
            }

            function pad(num, size) {
                var s = num + "";
                while (s.length < size) s = "0" + s;
                return s;
            }

            refreshItems();

            function refreshItems() {
                var searchedItems = angular.copy(items);

                if (vm.searchModel) {
                    console.log("searching: ", vm.searchModel);
                    searchedItems = items.filter(function (item) {
                        return item.name.toLowerCase().indexOf(vm.searchModel.toLowerCase()) != -1;
                    });
                }

                var pagination = vm.simple.pagination;
                var returnedItems = [];
                var startIndex = (pagination.page - 1) * pagination.pageSize;
                var endIndex = startIndex + pagination.pageSize;
                for (var i = startIndex; i < endIndex; i++) {
                    if (searchedItems[i]){
                        returnedItems.push(searchedItems[i]);
                    }
                }

                vm.simple.items = angular.copy(returnedItems); // make a copy to create new references

                if (vm.simple.sorting.sortBy) {
                    vm.simple.items = _.orderBy(vm.simple.items, [vm.simple.sorting.sortBy.id], [vm.simple.sorting.direction]);
                }

                pagination.total = vm.searchModel ? searchedItems.length : 200;
            }

            function callRefresh() {
                if (!initializing) {
                    refreshItems();
                }
            }

            $scope.$watchCollection(function () {
                return [vm.simple.pagination.page, vm.simple.pagination.pageSize,
                    vm.simple.sorting.sortBy, vm.simple.sorting.direction];
            }, callRefresh);

            $timeout(function () {
                initializing = false;
            }, 0);
        }

        controller.$inject = ["$scope", "$timeout"];
    })();
</script>


