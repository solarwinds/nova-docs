<div ng-controller="PerfBusyController as vm">
    <form>
        <div id="xuiBusyElementNotes"
             xui-busy="vm.isBusySavingNotes"
             xui-busy-message="{{ vm.saveNotesMessage }}"
             xui-allow-cancel="vm.showCancelButtonNotes"
             xui-busy-on-cancel="vm.onCancelNotes()"
             xui-busy-show-progress="{{vm.showProgress}}"
             xui-busy-percent="{{vm.percent}}"
             xui-busy-help-text="{{vm.helpText}}">
            <xui-textbox ng-model="vm.notes" caption="Notes" rows="5"></xui-textbox>
        </div>
    </form>
    <xui-button name="saveButton" display-style="primary" is-busy="vm.isBusySavingNotes" ng-click="vm.saveNotes()">Save With Progress</xui-button>
</div>


<script type="text/javascript">
    (function () {
        "use strict";

        Xui.controller("PerfBusyController", PerfBusyController, ["$interval", "$scope", "perfService"]);

        function PerfBusyController($interval, $scope, perfService) {

            var vm = this;
            // busy with progress bar
            var cancellationNotes;

            vm.isBusySavingNotes = false;
            vm.isCancellingNotes = false;
            vm.showCancelButtonNotes = true;

            vm.saveNotes = function() {
                vm.saveNotesMessage = "We're saving lots of notes...";
                vm.isBusySavingNotes = true;
                vm.showCancelButtonNotes = true;
                vm.showProgress = true;
                vm.percent = 0;
                vm.helpText = "This won't take long...";

                cancellationNotes = $interval(vm.updateProgress, 500);
            };

            vm.updateProgress = function() {
                if (vm.percent < 110) {
                    vm.percent += 10;
                } else {
                    vm.isBusySavingNotes = false;
                    vm.stopProgress();
                }
            };

            vm.stopProgress = function() {
                $interval.cancel(cancellationNotes);
                vm.percent = 0;
            };

            vm.onCancelNotes = function() {
                if (vm.isCancelling) return;

                vm.stopProgress();
                vm.isCancellingNotes = true;
                vm.saveNotesMessage = "Cancelling notes...";
                vm.helpText = "";

                vm.showCancelButtonNotes = false;
                vm.showProgress = false;
            };

            //register custom user metrics
            perfService.registerMetrics(["watchersCount", "digestLoop", "pageLoad"], $scope);

        }
    })();
</script>

