import{a as k}from"./chunk-XVGJVL2K.js";import{a as C}from"./chunk-VZBMOGXQ.js";import{a as S}from"./chunk-XTY2FQH5.js";import{a as s}from"./chunk-W4ZTUGCX.js";import{d as _}from"./chunk-THDOSL77.js";import{c as f}from"./chunk-WB3W4DUY.js";import{Aa as a,Ib as c,Ob as h,Pb as d,Sa as p,_c as y,ec as m,h as l,pb as u}from"./chunk-7UJBXEVU.js";var D=(()=>{class n{constructor(e,t){this.cd=e,this.toastService=t,this.readonly=!1,this.SEPARATOR=" ",this.placeholder="Click to start building query",this.value="",this.valueChange=new p,this.tokens=[],this.cursorSetter$$=new l(-1),this.currentCursorPos=this.cursorSetter$$.value,this.renderer=new S,this.currentHelp=[],this.tokenizer=new C,this.helpUpdater=new k}onValueChange(e){this.tokens=e.tokens,this.value!==e.value&&(this.value=e.value),this.updateHelp()}onCursorPosChange(e){this.currentCursorPos!==e&&(this.currentCursorPos=e,this.updateHelp(),this.cd.detectChanges())}onSubmit(){this.toastService.success({message:"Query was successfully submitted."})}updateTextAfterHelpSelection(e){let t=this.getFocusedTokenIndex();if(t===-1)this.value=this.value+e.value+this.SEPARATOR,this.cursorSetter$$.next(this.value.length);else{let r=this.tokens[t].start+e.value.length;this.value=this.value.substring(0,this.tokens[t].start)+e.value+this.value.substring(this.tokens[t].end+1),this.cursorSetter$$.next(r)}this.onCursorPosChange(this.value.length+1),this.checkValidity()}updateHelp(){let e=this.getFocusedTokenIndex();this.currentHelp=this.helpUpdater.getCurrentHelp(e,this.tokens)}getFocusedTokenIndex(){for(let e=0;e<this.tokens.length;e++)if(this.tokens[e].start<=this.currentCursorPos&&this.tokens[e].end>=this.currentCursorPos)return e;return-1}checkValidity(){switch(this.tokens.map(t=>t.type).toString()){case[s.SELECT_KEYWORD].toString():{let t=this.tokens.findIndex(r=>r.type===s.SELECT_KEYWORD);this.tokens[t].issue="error",this.tokens[t].issueMessage="You need to specify fields to select"}break;case[s.SELECT_KEYWORD,s.STRING,s.FROM_KEYWORD].toString():{let t=this.tokens.findIndex(r=>r.type===s.FROM_KEYWORD);this.tokens[t].issue="error",this.tokens[t].issueMessage="You need to specify table to select from"}break}}static{this.\u0275fac=function(t){return new(t||n)(u(y),u(f))}}static{this.\u0275cmp=a({type:n,selectors:[["nui-freetype-query-builder-basic-example"]],decls:1,vars:7,consts:[[3,"currentValue","cursorPos","submitQuery","helpItemSelected","value","currentHelp","tokenizer","renderer","placeholder","cursorSetter$","readonly"]],template:function(t,r){t&1&&(h(0,"nui-freetype-query-builder",0),m("currentValue",function(i){return r.onValueChange(i)})("cursorPos",function(i){return r.onCursorPosChange(i)})("submitQuery",function(){return r.onSubmit()})("helpItemSelected",function(i){return r.updateTextAfterHelpSelection(i)}),d()),t&2&&c("value",r.value)("currentHelp",r.currentHelp)("tokenizer",r.tokenizer)("renderer",r.renderer)("placeholder",r.placeholder)("cursorSetter$",r.cursorSetter$$)("readonly",r.readonly)},dependencies:[_],encapsulation:2})}}return n})();export{D as a};
